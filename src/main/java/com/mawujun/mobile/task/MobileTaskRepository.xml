<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!-- mawujun qq:16064988 e-mail:16064988@qq.com-->
<mapper namespace="com.mawujun.mobile.task.MobileTaskRepository">
	<select id="queryTasknum" resultType="map" parameterType="map">
    	select a.type,count(status) total_num
    	,sum(decode(a.status,'newTask',1,0)) newTask_num
    	,sum(decode(a.status,'read',1,0)) read_num
    	,sum(decode(a.status,'handling',1,0)) handling_num
    	,sum(decode(a.status,'submited',1,0)) submited_num
		from ems_task a,t_position_org_user b
		where a.workunit_id=b.org_id and b.user_id=#{user_id}
		and a.status!='complete'
		group by a.type
    </select>
    <!-- 查询任务-->
    <select id="queryTaskes" resultType="com.mawujun.task.TaskVO" parameterType="map">
    	select a.id,a.memo,a.type,a.status,a.pole_id,b.code as pole_code,b.longitude as pole_longitude,b.latitude as pole_latitude,b.name as pole_name,b.address as pole_address,a.createDate 
    	from ems_task a,ems_pole b,t_position_org_user c
    	where a.workunit_id=c.org_id and a.pole_id=b.id and c.user_id=#{user_id}
    	and a.type=#{type} and a.status =#{status}
		order by b.code asc
    </select>
    
    <select id="getMobileTaskVO" resultType="com.mawujun.mobile.task.MobileTaskVO" parameterType="map">
    	select a.id,a.memo,a.type,a.status,a.pole_id,b.code as pole_code,b.longitude as pole_longitude,b.latitude as pole_latitude,b.name as pole_name,b.address as pole_address,a.createDate 
    	,a.hitchType_id,c.name as hitchType_name,a.hitchReasonTpl_id,d.name as hitchReasonTpl_name,a.hitchReason
    	,a.handleMethod_id,e.name as handleMethod_name,a.handle_contact
    	from ems_task a
    	inner join ems_pole b on a.pole_id=b.id 
    	inner join ems_hitchtype c on a.hitchtype_id=c.id
    	inner join ems_hitchreasontpl d on a.hitchReasonTpl_id=d.id
    	inner join ems_handlemethod e on a.handleMethod_id=e.id
      	where a.id=#{task_id}
    </select>
    
    <select id="getMobileTaskVO_equiplist" resultType="com.mawujun.mobile.task.Equiplist" parameterType="map">
    	select a.ecode,c.name as subtype_name  from ems_taskequipmentlist a,ems_equipment b,ems_equipmentsubtype c
		where a.ecode=b.ecode and b.subtype_id=c.id and a.task_id=#{task_id}
    </select>
    
    
    <resultMap type="com.mawujun.task.HitchTypeVO" id="hitchTypeVOMap">  
        <id column="id" property="id"/>  
        <result column="name" property="name"/>  
        <collection property="hitchReasonTpls" ofType="com.mawujun.task.HitchReasonTpl">  
            <id column="tpl_id" property="id"/>  
            <result column="tpl_name" property="name"/>  
            <result column="tpl_tpl" property="tpl"/>  
        </collection>         
    </resultMap>
    <select id="queryAllHitchtype" resultMap="hitchTypeVOMap">
    	select a.id,a.name,b.id as tpl_id,b.name as tpl_name,b.tpl tpl_tpl 
		from ems_hitchtype a,ems_hitchreasontpl b
		where a.id=b.HITCHTYPE_ID
		order by a.id,b.id
    </select>
    
    <select id="scanEquip_info" resultType="com.mawujun.mobile.task.Equiplist" >
    	select b.ecode,c.name as subtype_name  from ems_equipment b,ems_equipmentsubtype c
		where  b.subtype_id=c.id and b.ecode=#{ecode}
    </select>
</mapper>

